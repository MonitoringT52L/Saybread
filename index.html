<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Saybread</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: 700;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .table th {
            background-color: #4e73df;
            color: white;
            font-weight: 600;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(78, 115, 223, 0.05);
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2e59d9;
        }
        .btn-success {
            background-color: #1cc88a;
            border-color: #1cc88a;
        }
        .btn-success:hover {
            background-color: #17a673;
            border-color: #17a673;
        }
        .btn-github {
            background-color: #333;
            border-color: #333;
            color: white;
        }
        .btn-github:hover {
            background-color: #24292e;
            border-color: #24292e;
            color: white;
        }
        .total-cell {
            font-weight: 700;
            background-color: #f8f9fc;
        }
        h2 {
            color: #5a5c69;
            font-weight: 700;
            border-left: 4px solid #4e73df;
            padding-left: 10px;
        }
        .date-header {
            color: #5a5c69;
            font-weight: 600;
        }
        input[type="number"] {
            text-align: center;
            font-weight: 500;
        }
        .container {
            max-width: 1200px;
        }
        .github-config {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .github-status {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .nav-tabs .nav-link {
            color: #5a5c69;
            font-weight: 600;
            padding: 12px 20px;
        }
        .nav-tabs .nav-link.active {
            color: #4e73df;
            border-bottom: 3px solid #4e73df;
        }
        .tab-content {
            padding: 20px 0;
        }
        .github-instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #4e73df;
            padding: 15px;
            margin-bottom: 20px;
        }
        .save-indicator {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9rem;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-bread-slice me-2"></i>Monitoring Saybread
            </a>
            <div class="ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-calendar-alt me-1"></i>
                    <span id="current-date"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button" role="tab" aria-controls="form" aria-selected="true">
                    <i class="fas fa-table me-2"></i>Form Input Data
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="github-tab" data-bs-toggle="tab" data-bs-target="#github" type="button" role="tab" aria-controls="github" aria-selected="false">
                    <i class="fab fa-github me-2"></i>Konfigurasi GitHub
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Form Input Data Tab -->
            <div class="tab-pane fade show active" id="form" role="tabpanel" aria-labelledby="form-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h2>MONITORING SAYBREAD</h2>
                                <p class="date-header">TANGGAL: <span id="selected-date"></span></p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="d-flex justify-content-end align-items-center">
                                    <div class="input-group me-2" style="max-width: 250px;">
                                        <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                                        <input type="date" class="form-control" id="date-selector">
                                    </div>
                                    <button class="btn btn-primary" type="button" id="change-date">
                                        <i class="fas fa-sync-alt me-1"></i>Pilih
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="5%">NO</th>
                                        <th width="45%">SAYBREAD</th>
                                        <th width="15%">MALAM</th>
                                        <th width="15%">SIANG</th>
                                        <th width="20%">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody id="bread-table-body">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 text-end">
                            <button id="save-data" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Simpan Data
                            </button>
                            <span id="save-indicator" class="save-indicator"></span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Petunjuk:</strong> Isi jumlah stok untuk setiap roti pada kolom MALAM dan SIANG. Total akan dihitung secara otomatis. Data akan disimpan secara otomatis ke GitHub dan penyimpanan lokal.
                </div>
            </div>
            
            <!-- GitHub Configuration Tab -->
            <div class="tab-pane fade" id="github" role="tabpanel" aria-labelledby="github-tab">
                <div class="github-instructions">
                    <h4><i class="fas fa-info-circle me-2"></i>Petunjuk Konfigurasi GitHub</h4>
                    <ol>
                        <li>Buka <a href="https://github.com/settings/tokens" target="_blank">GitHub Token Settings</a></li>
                        <li>Klik "Generate new token"</li>
                        <li>Beri nama token (contoh: "Monitoring Saybread")</li>
                        <li>Pilih scope "repo"</li>
                        <li>Klik "Generate token"</li>
                        <li>Salin token yang dihasilkan dan tempel di form ini</li>
                    </ol>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fab fa-github me-2"></i>Konfigurasi GitHub</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="github-token" class="form-label">GitHub Personal Access Token</label>
                                    <input type="password" class="form-control" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxx">
                                    <div class="form-text">Dibutuhkan: scope repo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="github-repo" class="form-label">Nama Repository</label>
                                    <input type="text" class="form-control" id="github-repo" placeholder="username/repo-name">
                                    <div class="form-text">Format: username/nama-repository</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="github-path" class="form-label">Path File di Repository</label>
                            <input type="text" class="form-control" id="github-path" value="data/saybread-data.json">
                            <div class="form-text">Path tempat data akan disimpan</div>
                        </div>
                        <div class="mb-3">
                            <label for="github-branch" class="form-label">Branch</label>
                            <input type="text" class="form-control" id="github-branch" value="main">
                            <div class="form-text">Nama branch repository</div>
                        </div>
                        <button id="test-github" class="btn btn-outline-primary me-2">
                            <i class="fas fa-plug me-1"></i>Test Koneksi
                        </button>
                        <button id="save-github-config" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Simpan Konfigurasi
                        </button>
                        <span id="github-status" class="github-status status-disconnected ms-2">Terkoneksi</span>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-history me-2"></i>Riwayat Simpan ke GitHub</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Status</th>
                                        <th>Pesan</th>
                                    </tr>
                                </thead>
                                <tbody id="github-history">
                                    <tr>
                                        <td colspan="3" class="text-center">Belum ada riwayat</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-light">
        <div class="container text-center">
            <p class="mb-0">Monitoring Saybread &copy; 2023 - Aplikasi Monitoring Stok Roti</p>
        </div>
    </footer>

    <!-- Toast for notifications -->
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
        <div class="toast-header">
            <strong class="me-auto">Monitoring Saybread</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize toast
            const toastEl = document.querySelector('.toast');
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            
            // Show toast notification
            function showToast(message, type = 'info') {
                const toastBody = document.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.show();
            }
            
            // Update save indicator
            function updateSaveIndicator(text, isSaving = false) {
                const indicator = document.getElementById('save-indicator');
                if (isSaving) {
                    indicator.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${text}`;
                } else {
                    indicator.innerHTML = text;
                }
            }
            
            // Bread data
            const breads = [
                "CHOCO FLAT",
                "POLO COKLAT",
                "BOULE HOKAIDO",
                "CHOCO FLAT",
                "CREAM CHESEE",
                "CHOCO TOPING",
                "DOUBLE CHESE",
                "SAUSAGE",
                "APPLE PIE",
                "CHESEBUN",
                "CHOCO CROISAN",
                "WALNUT",
                "MINI GERMAN",
                "POLO MARTABAK"
            ];
            
            // Populate table
            const tableBody = document.getElementById('bread-table-body');
            breads.forEach((bread, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${bread}</td>
                    <td>
                        <input type="number" class="form-control morning-stock" value="0" min="0">
                    </td>
                    <td>
                        <input type="number" class="form-control day-stock" value="0" min="0">
                    </td>
                    <td class="total-cell text-center">0</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Set tanggal hari ini
            const today = new Date();
            const formattedDate = formatDate(today);
            document.getElementById('current-date').textContent = formattedDate;
            document.getElementById('selected-date').textContent = formattedDate;
            document.getElementById('date-selector').value = formatDateForInput(today);
            
            // Format tanggal untuk tampilan
            function formatDate(date) {
                const options = { day: '2-digit', month: 'long', year: 'numeric' };
                return date.toLocaleDateString('id-ID', options);
            }
            
            // Format tanggal untuk input type="date"
            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Hitung total otomatis
            document.querySelectorAll('.morning-stock, .day-stock').forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const morning = parseInt(row.querySelector('.morning-stock').value) || 0;
                    const day = parseInt(row.querySelector('.day-stock').value) || 0;
                    row.querySelector('.total-cell').textContent = morning + day;
                });
            });
            
            // Load saved configuration
            function loadConfig() {
                const token = localStorage.getItem('github_token');
                const repo = localStorage.getItem('github_repo');
                const path = localStorage.getItem('github_path');
                const branch = localStorage.getItem('github_branch') || 'main';
                
                if (token) document.getElementById('github-token').value = token;
                if (repo) document.getElementById('github-repo').value = repo;
                if (path) document.getElementById('github-path').value = path;
                document.getElementById('github-branch').value = branch;
                
                if (token && repo) {
                    document.getElementById('github-status').textContent = 'Terkoneksi';
                    document.getElementById('github-status').className = 'github-status status-connected ms-2';
                }
                
                // Load history
                loadHistory();
            }
            
            // Load GitHub history
            function loadHistory() {
                const history = JSON.parse(localStorage.getItem('github_history') || '[]');
                const historyTable = document.getElementById('github-history');
                
                if (history.length === 0) {
                    historyTable.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada riwayat</td></tr>';
                    return;
                }
                
                historyTable.innerHTML = '';
                history.slice(-10).reverse().forEach(item => {
                    const row = document.createElement('tr');
                    const statusClass = item.status === 'success' ? 'text-success' : 'text-danger';
                    row.innerHTML = `
                        <td>${new Date(item.timestamp).toLocaleString('id-ID')}</td>
                        <td class="${statusClass}">${item.status === 'success' ? 'Berhasil' : 'Gagal'}</td>
                        <td>${item.message}</td>
                    `;
                    historyTable.appendChild(row);
                });
            }
            
            // Save GitHub configuration
            document.getElementById('save-github-config').addEventListener('click', function() {
                const token = document.getElementById('github-token').value;
                const repo = document.getElementById('github-repo').value;
                const path = document.getElementById('github-path').value;
                const branch = document.getElementById('github-branch').value;
                
                if (!token || !repo) {
                    showToast('Token dan Repository harus diisi', 'error');
                    return;
                }
                
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_repo', repo);
                localStorage.setItem('github_path', path);
                localStorage.setItem('github_branch', branch);
                
                document.getElementById('github-status').textContent = 'Terkoneksi';
                document.getElementById('github-status').className = 'github-status status-connected ms-2';
                
                showToast('Konfigurasi GitHub berhasil disimpan');
            });
            
            // Test GitHub connection
            document.getElementById('test-github').addEventListener('click', function() {
                const token = document.getElementById('github-token').value;
                const repo = document.getElementById('github-repo').value;
                
                if (!token || !repo) {
                    showToast('Token dan Repository harus diisi', 'error');
                    return;
                }
                
                // Simple test by trying to get repo info
                fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Koneksi GitHub berhasil');
                        document.getElementById('github-status').textContent = 'Terkoneksi';
                        document.getElementById('github-status').className = 'github-status status-connected ms-2';
                    } else {
                        throw new Error('Koneksi gagal');
                    }
                })
                .catch(error => {
                    showToast('Koneksi GitHub gagal: ' + error.message, 'error');
                    document.getElementById('github-status').textContent = 'Tidak Terkoneksi';
                    document.getElementById('github-status').className = 'github-status status-disconnected ms-2';
                });
            });
            
            // Save data to GitHub
            async function saveToGitHub(data) {
                const token = localStorage.getItem('github_token');
                const repo = localStorage.getItem('github_repo');
                const path = localStorage.getItem('github_path') || 'data/saybread-data.json';
                const branch = localStorage.getItem('github_branch') || 'main';
                
                if (!token || !repo) {
                    throw new Error('Konfigurasi GitHub belum lengkap');
                }
                
                // Check if file exists and get its SHA for update
                let sha = null;
                try {
                    const fileInfo = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (fileInfo.ok) {
                        const fileData = await fileInfo.json();
                        sha = fileData.sha;
                    }
                } catch (error) {
                    // File doesn't exist, we'll create it
                }
                
                // Prepare the content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                // Create or update the file
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update data monitoring saybread: ${data.date}`,
                        content: content,
                        branch: branch,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Gagal menyimpan ke GitHub');
                }
                
                return response.json();
            }
            
            // Add to GitHub history
            function addToHistory(status, message) {
                const history = JSON.parse(localStorage.getItem('github_history') || '[]');
                history.push({
                    timestamp: new Date().toISOString(),
                    status: status,
                    message: message
                });
                localStorage.setItem('github_history', JSON.stringify(history));
                loadHistory();
            }
            
            // Save data to local storage
            function saveToLocal(data) {
                const dateKey = `saybread_${data.date.replace(/-/g, '')}`;
                localStorage.setItem(dateKey, JSON.stringify(data));
                return true;
            }
            
            // Load data from local storage
            function loadFromLocal(date) {
                const dateKey = `saybread_${date.replace(/-/g, '')}`;
                const data = localStorage.getItem(dateKey);
                return data ? JSON.parse(data) : null;
            }
            
            // Save data function (both to GitHub and local)
            async function saveData() {
                // Collect data from table
                const date = document.getElementById('date-selector').value;
                const rows = document.querySelectorAll('#bread-table-body tr');
                const data = {
                    date: date,
                    breads: []
                };
                
                rows.forEach(row => {
                    const name = row.cells[1].textContent;
                    const morning = parseInt(row.querySelector('.morning-stock').value) || 0;
                    const day = parseInt(row.querySelector('.day-stock').value) || 0;
                    const total = morning + day;
                    
                    data.breads.push({
                        name: name,
                        morning: morning,
                        day: day,
                        total: total
                    });
                });
                
                // Save to local storage
                saveToLocal(data);
                
                // Try to save to GitHub
                updateSaveIndicator('Menyimpan ke GitHub...', true);
                
                try {
                    await saveToGitHub(data);
                    updateSaveIndicator('Data tersimpan di GitHub dan lokal');
                    showToast('Data berhasil disimpan ke GitHub dan penyimpanan lokal');
                    addToHistory('success', 'Data berhasil disimpan ke GitHub');
                } catch (error) {
                    updateSaveIndicator('Data tersimpan hanya di lokal');
                    showToast(`Data disimpan di lokal, gagal ke GitHub: ${error.message}`, 'error');
                    addToHistory('error', `Gagal: ${error.message}`);
                }
            }
            
            // Load data for selected date
            function loadDataForDate(date) {
                const data = loadFromLocal(date);
                
                if (data) {
                    const rows = document.querySelectorAll('#bread-table-body tr');
                    data.breads.forEach((bread, index) => {
                        if (index < rows.length) {
                            rows[index].querySelector('.morning-stock').value = bread.morning;
                            rows[index].querySelector('.day-stock').value = bread.day;
                            rows[index].querySelector('.total-cell').textContent = bread.total;
                        }
                    });
                    showToast(`Data untuk tanggal ${date} dimuat`);
                } else {
                    // Reset all inputs if no data found
                    document.querySelectorAll('.morning-stock, .day-stock').forEach(input => {
                        input.value = '0';
                    });
                    document.querySelectorAll('.total-cell').forEach(cell => {
                        cell.textContent = '0';
                    });
                }
            }
            
            // Event listener for save button
            document.getElementById('save-data').addEventListener('click', saveData);
            
            // Event listener for date change
            document.getElementById('change-date').addEventListener('click', function() {
                const selectedDate = document.getElementById('date-selector').value;
                document.getElementById('selected-date').textContent = formatDate(new Date(selectedDate));
                loadDataForDate(selectedDate);
            });
            
            // Initialize
            loadConfig();
            loadDataForDate(document.getElementById('date-selector').value);
        });
    </script>
</body>
</html>
